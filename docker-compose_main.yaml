services:
  #+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++#
  #-------------------------------------------------------------------------------------------------------------#
  gateway:
    image: fr-server-gateway_server_service:latest
    container_name: fr_gateway
    environment:
      - NAMESPACE=${SERVER_NAME}
      - SERVICE_TYPE=gateway
      - CONFIG_PROFILE=${CONFIG_PROFILE:-prod-1gpu-24gb}
      - SERVER_IP=0.0.0.0
      - SERVER_PORT=8000
      - ENDPOINT_PATH=/ws
      - REDIS_HOSTNAME=Redis_Server
      - REDIS_HOSTPORT=6379
      - RMQ_URL=amqp://admin:admin123@rmq_Server:5672
      - STORAGE_ENDPOINT=${STORAGE_ENDPOINT:-minio:9000}
      - STORAGE_ACCESS_KEY=${STORAGE_ACCESS_KEY:-minioadmin}
      - STORAGE_SECRET_KEY=${STORAGE_SECRET_KEY:-minioadmin}
      - STORAGE_SECURE=${STORAGE_SECURE:-false}
      - STORAGE_FRAMES_BUCKET=${STORAGE_FRAMES_BUCKET:-face-frames}
    volumes:
      - type: bind
        source: ${DATA_DIR}/logs/${SERVER_NAME}
        target: /app/${SERVER_NAME}/logs
      - type: bind
        source: ${DATA_DIR}
        target: /app/Data
    depends_on:
      - Redis_Server
      - rmq_Server
      - Load_Balancer
      - minio
    networks:
      - load_balance_network
      - redis_network
      - rmq_network
      - storage_network
    restart: unless-stopped
  #+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++#
  #-------------------------------------------------------------------------------------------------------------#
  # Pipeline Manager Service
  pipelines-manager:
    image: fr-server-pipelines_manager_service:latest
    container_name: fr_pipelines_manager
    environment:
      - NAMESPACE=${SERVER_NAME}
      - SERVICE_TYPE=pipelines-manager
      - CONFIG_PROFILE=${CONFIG_PROFILE:-prod-1gpu-24gb}
      - REDIS_HOSTNAME=Redis_Server
      - REDIS_HOSTPORT=6379
      - RMQ_URL=amqp://admin:admin123@rmq_Server:5672
    volumes:
      - type: bind
        source: ${DATA_DIR}/logs/${SERVER_NAME}
        target: /app/${SERVER_NAME}/logs
    depends_on:
      - Redis_Server
      - rmq_Server
    networks:
      - redis_network
      - rmq_network
      - storage_network
    restart: unless-stopped
  #+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++#
  #-------------------------------------------------------------------------------------------------------------#
  # Decision Manager Service
  decision-manager:
    image: fr-server-decision_manager_service:latest
    container_name: fr_decision_manager
    environment:
      - SERVICE_TYPE=decision-manager
      - RMQ_URL=amqp://admin:admin123@rmq_Server:5672
      - NAMESPACE=${SERVER_NAME}
    volumes:
      - type: bind
        source: ${DATA_DIR}/logs/${SERVER_NAME}
        target: /app/${SERVER_NAME}/logs
      - type: bind
        source: ${DATA_DIR}
        target: /app/Data
    depends_on:
      - rmq_Server
    networks:
      - rmq_network
    restart: unless-stopped
  #+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++#
  #-------------------------------------------------------------------------------------------------------------#
  # Monitoring Service (optional - enable via compose profile 'monitoring')
  monitoring:
    image: fr-server-monitoring_service:latest
    container_name: fr_monitoring
    profiles:
      - monitoring
    environment:
      - MONITORING_REDIS_HOST=Redis_Server
      - MONITORING_REDIS_PORT=6379
      - MONITORING_REDIS_DB=0
      - MONITORING_RMQ_URL=amqp://admin:admin123@rmq_Server:5672
      - MONITORING_PORT=${MONITORING_PORT:-8080}
      - MONITORING_MINIO_ENDPOINT=${STORAGE_ENDPOINT:-minio:9000}
      - MONITORING_MINIO_ACCESS_KEY=${STORAGE_ACCESS_KEY:-minioadmin}
      - MONITORING_MINIO_SECRET_KEY=${STORAGE_SECRET_KEY:-minioadmin}
      - MONITORING_MINIO_SECURE=${STORAGE_SECURE:-false}
    ports:
      - "${MONITORING_PORT:-8080}:8080"
    networks:
      - redis_network
      - rmq_network
      - storage_network
    restart: unless-stopped
  #+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++#
  #-------------------------------------------------------------------------------------------------------------#
  # Server Manager Service
  server-manager:
    image: fr-server-server_manager_service:latest
    container_name: fr_server_manager
    ports:
      - "${SERVER_MANAGER_PORT}:${SERVER_MANAGER_PORT}"
    environment:
      - SERVICE_TYPE=server-manager
      - NAMESPACE=${SERVER_NAME}
      - SERVER_NAME=${SERVER_NAME}
      - REDIS_HOSTNAME=Redis_Server
      - REDIS_HOSTPORT=6379
      - RMQ_URL=amqp://admin:admin123@rmq_Server:5672
      - GUI_BACKEND_IP=${SERVER_MANAGER_1_IP}
      - GUI_BACKEND_PORT=${SERVER_MANAGER_PORT}
      - GUI_ORIGIN_URL=${GUI_ORIGIN_IP}:${GUI_ORIGIN_PORT}
    volumes:
      - type: bind
        source: ${DATA_DIR}/logs/${SERVER_NAME}
        target: /app/${SERVER_NAME}/logs
      - type: bind
        source: ${DATA_DIR}
        target: /app/Data
    depends_on:
      - rmq_Server
      - Redis_Server
    networks:
      redis_network:
      rmq_network:
      gui_network:
        ipv4_address: ${SERVER_MANAGER_1_IP}
    restart: unless-stopped
  #-------------------------------------------------------------------------------------------------------------#
  #Redis Server
  #+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++#
  minio:
    image: minio/minio
    container_name: fr_minio
    environment:
      - MINIO_ROOT_USER=${STORAGE_ACCESS_KEY:-minioadmin}
      - MINIO_ROOT_PASSWORD=${STORAGE_SECRET_KEY:-minioadmin}
    command: server /data --console-address ":9001"
    volumes:
      - type: volume
        source: minio_data
        target: /data
    ports:
      - "${MINIO_API_PORT:-9100}:9000"
      - "${MINIO_CONSOLE_PORT:-9001}:9001"
    networks:
      - storage_network
    restart: unless-stopped
  #+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++#
  #-------------------------------------------------------------------------------------------------------------#
  Redis_Server:
    image: redis:8.0.2
    container_name: Redis_Server
    hostname: Redis_Server
    restart: unless-stopped
    command: redis-server --save "" --appendonly no
    volumes:
      - type: volume
        source: redis_data
        target: /data
    networks:
      redis_network:
        aliases:
          - Redis_Server
  #-------------------------------------------------------------------------------------------------------------#
  #+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++#
  #Redis Server
  #+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++#
  rmq_Server:
    image: rabbitmq:4-management
    container_name: rmq_Server
    restart: unless-stopped
    environment:
      RABBITMQ_DEFAULT_USER: admin
      RABBITMQ_DEFAULT_PASS: admin123
    ports:
      - "5672:5672"
      - "15672:15672"
    volumes:
      - type: volume
        source: rmq_data
        target: /var/lib/rabbitmq
    networks:
      - rmq_network
      - rmq_network_gui
  #-------------------------------------------------------------------------------------------------------------#
  #+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++#
  #Load Balancer
  #+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++#
  Load_Balancer:
    image: fr_loadbalance:0
    restart: unless-stopped
    environment:
      - GATEWAY_HOST=fr_gateway
      - GATEWAY_PORT=8000
      - NGINX_PORT=80
    networks:
      - fr_network
      - load_balance_network
    ports:
      - "8000:80"
    volumes:
      - ${ROOT_PATH}/config_templates/nginx.conf.template:/etc/nginx/templates/nginx.conf.template:ro

    command: /bin/sh -c "envsubst < /etc/nginx/templates/nginx.conf.template > /etc/nginx/nginx.conf && nginx -g 'daemon off;'"

#**************************************************************************************************************#
#**************************************************************************************************************#
volumes:
  redis_data:
    driver: local
  #______________________________________________________________________________________________________________#
  rmq_data:
    driver: local
  #______________________________________________________________________________________________________________#
  minio_data:
    driver: local
#**************************************************************************************************************#
networks:
  load_balance_network:
    name: load_balance_network
    driver: bridge
    internal: True
  #______________________________________________________________________________________________________________#
  rmq_network:
    name: rmq_network
    driver: bridge
    internal: True
  #______________________________________________________________________________________________________________#
  rmq_network_gui:
    name: rmq_network_gui
    driver: bridge
  #______________________________________________________________________________________________________________#
  gui_network:
    name: fr_gui_network
    driver: bridge
    ipam:
      config:
        - subnet: 50.50.0.0/16
          gateway: 50.50.0.1
  #______________________________________________________________________________________________________________#
  redis_network:
    name: redis_network
    driver: bridge
    internal: True
  #______________________________________________________________________________________________________________#
  fr_network:
    name: fr_network
    driver: bridge
  #______________________________________________________________________________________________________________#
  storage_network:
    name: storage_network
    driver: bridge
