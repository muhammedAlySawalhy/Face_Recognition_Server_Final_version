services:
  #+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++#
  #-------------------------------------------------------------------------------------------------------------#
  gateway:
    image: fr-server-gateway_server_service:latest
    container_name: fr_gateway
    environment:
      - NAMESPACE=${SERVER_NAME}
      - SERVICE_TYPE=gateway
      - TZ=Africa/Cairo
      - CONFIG_PROFILE=${CONFIG_PROFILE:-prod-1gpu-24gb}
      - SERVER_IP=0.0.0.0
      - SERVER_PORT=8001
      - ENDPOINT_PATH=/ws
      - REDIS_HOSTNAME=Redis_Server
      - REDIS_HOSTPORT=6379
      - RMQ_URL=amqp://admin:admin123@rmq_Server:5672
      - STORAGE_ENDPOINT=${STORAGE_ENDPOINT:-minio:9000}
      - STORAGE_ACCESS_KEY=${STORAGE_ACCESS_KEY:-minioadmin}
      - STORAGE_SECRET_KEY=${STORAGE_SECRET_KEY:-minioadmin}
      - STORAGE_SECURE=${STORAGE_SECURE:-false}
      - STORAGE_FRAMES_BUCKET=${STORAGE_FRAMES_BUCKET:-face-frames}
    volumes:
      - type: bind
        source: ${DATA_DIR}/logs/${SERVER_NAME}
        target: /app/${SERVER_NAME}/logs
      - type: bind
        source: ${DATA_DIR}
        target: /app/Data
    depends_on:
      minio:
        condition: service_healthy
      Redis_Server:
        condition: service_started
      rmq_Server:
        condition: service_started
      Load_Balancer:
        condition: service_started
    ports:
      - "0.0.0.0:${GATEWAY_PORT:-8001}:8001"
    networks:
      - load_balance_network
      - redis_network
      - rmq_network
      - storage_network
    restart: unless-stopped
  #+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++#
  #-------------------------------------------------------------------------------------------------------------#
  # Pipeline Manager Service
  pipelines-manager:
    image: fr-server-pipelines_manager_service:latest
    container_name: fr_pipelines_manager
    environment:
      - NAMESPACE=${SERVER_NAME}
      - SERVICE_TYPE=pipelines-manager
      - TZ=Africa/Cairo
      - CONFIG_PROFILE=${CONFIG_PROFILE:-prod-1gpu-24gb}
      - REDIS_HOSTNAME=Redis_Server
      - REDIS_HOSTPORT=6379
      - RMQ_URL=amqp://admin:admin123@rmq_Server:5672
    volumes:
      - type: bind
        source: ${DATA_DIR}/logs/${SERVER_NAME}
        target: /app/${SERVER_NAME}/logs
    depends_on:
      - Redis_Server
      - rmq_Server
    networks:
      - redis_network
      - rmq_network
      - storage_network
    restart: unless-stopped
  #+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++#
  #-------------------------------------------------------------------------------------------------------------#
  # Decision Manager Service
  decision-manager:
    image: fr-server-decision_manager_service:latest
    container_name: fr_decision_manager
    environment:
      - SERVICE_TYPE=decision-manager
      - TZ=Africa/Cairo
      - RMQ_URL=amqp://admin:admin123@rmq_Server:5672
      - NAMESPACE=${SERVER_NAME}
    volumes:
      - type: bind
        source: ${DATA_DIR}/logs/${SERVER_NAME}
        target: /app/${SERVER_NAME}/logs
      - type: bind
        source: ${DATA_DIR}
        target: /app/Data
    depends_on:
      - rmq_Server
    networks:
      - rmq_network
      - storage_network
    restart: unless-stopped
  #+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++#
  #-------------------------------------------------------------------------------------------------------------#
  # Server Manager Service
  server-manager:
    image: fr-server-server_manager_service:latest
    container_name: fr_server_manager
    ports:
      - "0.0.0.0:${SERVER_MANAGER_PORT}:${SERVER_MANAGER_PORT}"
    environment:
      - SERVICE_TYPE=server-manager
      - NAMESPACE=${SERVER_NAME}
      - SERVER_NAME=${SERVER_NAME}
      - TZ=Africa/Cairo
      - REDIS_HOSTNAME=Redis_Server
      - REDIS_HOSTPORT=6379
      - RMQ_URL=amqp://admin:admin123@rmq_Server:5672
      - GUI_BACKEND_IP=${SERVER_MANAGER_1_IP}
      - GUI_BACKEND_PORT=${SERVER_MANAGER_PORT}
      - GUI_ORIGIN_URL=${GUI_ORIGIN_IP}:${GUI_ORIGIN_PORT}
    volumes:
      - type: bind
        source: ${DATA_DIR}/logs/${SERVER_NAME}
        target: /app/${SERVER_NAME}/logs
      - type: bind
        source: ${DATA_DIR}
        target: /app/Data
    depends_on:
      - rmq_Server
      - Redis_Server
    networks:
      redis_network:
      rmq_network:
      storage_network:
      gui_network:
        ipv4_address: ${SERVER_MANAGER_1_IP}
    restart: unless-stopped
  #-------------------------------------------------------------------------------------------------------------#
  #MinIO Server
  #+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++#
  minio:
    image: minio/minio:latest
    container_name: fr_minio
    command: server /data --console-address ":9001"
    environment:
      - TZ=Africa/Cairo
      - MINIO_REGION_NAME=${STORAGE_REGION:-us-east-1}
      - MINIO_ROOT_USER=${STORAGE_ACCESS_KEY:-minioadmin}
      - MINIO_ROOT_PASSWORD=${STORAGE_SECRET_KEY:-minioadmin}
    ports:
      - "${MINIO_API_PORT:-9100}:9000" # S3 API
      - "${MINIO_CONSOLE_PORT:-9001}:9001" # Console
    volumes:
      - /srv/minio:/data
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9000/minio/health/ready"]
      interval: 30s
      timeout: 20s
      retries: 3
      start_period: 60s
    networks:
      storage_network:
        aliases:
          - minio

  #+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++#
  # MinIO Cleanup Service 
  #+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++#
  minio-cleanup:
    image: minio/mc:latest
    container_name: fr_minio_cleanup
    environment:
      - STORAGE_FRAMES_BUCKET=${STORAGE_FRAMES_BUCKET:-face-frames}
      - RETENTION_HOURS=${RETENTION_HOURS:-1}
      - STORAGE_ACCESS_KEY=${STORAGE_ACCESS_KEY:-minioadmin}
      - STORAGE_SECRET_KEY=${STORAGE_SECRET_KEY:-minioadmin}
      - CLEANUP_INTERVAL_MINUTES=5
    entrypoint: >
      sh -c "
        echo 'Using direct MC approach...';
        
        # Wait a bit for network to stabilize
        sleep 10;
        
        # Direct MC setup without complex checks
        mc alias set myminio http://minio:9000 $${STORAGE_ACCESS_KEY} $${STORAGE_SECRET_KEY};
        mc mb myminio/$${STORAGE_FRAMES_BUCKET} || true;
        
        echo 'Cleanup service started';
        while true; do
          echo \"\$(date) - Running cleanup\";
          mc find myminio/$${STORAGE_FRAMES_BUCKET}/frames/ --older-than $${RETENTION_HOURS}h --exec 'mc rm --force {}' 2>/dev/null || true;
          sleep $$(( $${CLEANUP_INTERVAL_MINUTES} * 60 ));
        done
      "
    networks:
      storage_network:
        aliases:
          - minio-cleanup
  #-------------------------------------------------------------------------------------------------------------#
  #Redis Server
  #+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++#
  Redis_Server:
    image: redis:8.0.2
    container_name: Redis_Server
    hostname: Redis_Server
    restart: unless-stopped
    environment:
      - TZ=Africa/Cairo
    command: redis-server --save "" --appendonly no
    volumes:
      - type: volume
        source: redis_data
        target: /data
    networks:
      redis_network:
        aliases:
          - Redis_Server
  #-------------------------------------------------------------------------------------------------------------#
  #+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++#
  #RabbitMQ Server
  #+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++#
  rmq_Server:
    image: rabbitmq:4-management
    container_name: rmq_Server
    restart: unless-stopped
    environment:
      TZ: Africa/Cairo
      RABBITMQ_DEFAULT_USER: admin
      RABBITMQ_DEFAULT_PASS: admin123
    ports:
      - "5672:5672"
      - "15672:15672"
    volumes:
      - type: volume
        source: rmq_data
        target: /var/lib/rabbitmq
    networks:
      - rmq_network
      - rmq_network_gui
  #-------------------------------------------------------------------------------------------------------------#
  #+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++#
  #Load Balancer
  #+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++#
  Load_Balancer:
    image: fr_loadbalance:0
    restart: unless-stopped
    environment:
      - GATEWAY_HOST=fr_gateway
      - GATEWAY_PORT=8001
      - TZ=Africa/Cairo
      - NGINX_PORT=80
    networks:
      - fr_network
      - load_balance_network
    ports:
      - "8000:80"
    volumes:
      - ${ROOT_PATH}/config_templates/nginx.conf.template:/etc/nginx/templates/nginx.conf.template:ro
    command: /bin/sh -c "envsubst '$$GATEWAY_HOST $$GATEWAY_PORT $$NGINX_PORT' < /etc/nginx/templates/nginx.conf.template > /etc/nginx/nginx.conf && nginx -g 'daemon off;'"

#**************************************************************************************************************#
#**************************************************************************************************************#
volumes:
  redis_data:
    driver: local
  #______________________________________________________________________________________________________________#
  rmq_data:
    driver: local
  #______________________________________________________________________________________________________________#
  minio_data:
    driver: local
#**************************************************************************************************************#
networks:
  load_balance_network:
    external: true
    name: load_balance_network
  #______________________________________________________________________________________________________________#
  rmq_network:
    external: true
    name: rmq_network
  #______________________________________________________________________________________________________________#
  rmq_network_gui:
    external: true
    name: rmq_network_gui
  #______________________________________________________________________________________________________________#
  gui_network:
    external: true
    name: fr_gui_network
  #______________________________________________________________________________________________________________#
  redis_network:
    external: true
    name: redis_network
  #______________________________________________________________________________________________________________#
  fr_network:
    external: true
    name: fr_network
  #______________________________________________________________________________________________________________#
  storage_network:
    external: true
    name: storage_network